"use strict";
var async = require("async");
var Promise = require("bluebird");
var lsusbdev_1 = require("lsusbdev");
var mrtu = require("modbus-serial");
var Models = require('./models.json');
var Model;
var Client = new mrtu();
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = function (o) {
    return new Promise(function (resolve, reject) {
        var answer = {};
        var registers;
        function availablemodels() {
            var models = [];
            for (var i = 0; i < Models.length; i++) {
                models.push(Models[i].label);
            }
            return models;
        }
        function connectRTU() {
            function start() {
                Client.setID(o.id);
                async.eachSeries(registers, function (regi, cb) {
                    Client.readInputRegisters(regi.reg, 2, function (err, data) {
                        if (err) {
                            cb(err);
                        }
                        else {
                            if (regi.group) {
                                if (!answer[regi.group])
                                    answer[regi.group] = {};
                                answer[regi.group][regi.label] = data.buffer.readFloatBE();
                            }
                            else {
                                answer[regi.label] = data.buffer.readFloatBE();
                            }
                            cb();
                        }
                    });
                }, function (err) {
                    Client.close();
                    if (err) {
                        reject(err);
                    }
                    else {
                        var pkg = require("./package.json");
                        answer.apiVersion = pkg.name + ' - ' + pkg.version;
                        if (o.uid) {
                            answer.uid = o.uid;
                            answer._id = "consumption_" + o.uid;
                        }
                        answer.unixTimestamp = new Date().getTime();
                        resolve(answer);
                    }
                });
            }
            Client.setTimeout(10000);
            Client.connectRTUBuffered(o.dev, { baudrate: o.baud }, start);
        }
        if (!o) {
            reject("No conf provided");
        }
        else if (!o.dev && !o.hub) {
            reject("No dev");
        }
        else if (!o.model) {
            reject("No model provided. Available models are: " + availablemodels());
        }
        else {
            for (var i = 0; i < Models.length; i++) {
                if (Models[i].label === o.model) {
                    registers = Models[i].registers;
                }
            }
            if (registers && registers.length && registers[0] && (registers[0].reg || registers[0].reg === 0) && registers[0].label) {
                if (o.dev) {
                    connectRTU();
                }
                else if (!o.dev && o.hub) {
                    lsusbdev_1.default().then(function (data) {
                        for (var i = 0; i < data.length; i++) {
                            if (data[i].hub === o.hub) {
                                o.dev = data[i].dev;
                            }
                        }
                        if (o.dev) {
                            connectRTU();
                        }
                        else {
                            reject("No dev for " + o.hub);
                        }
                    }).catch(function (err) {
                        reject(err);
                    });
                }
            }
            else {
                reject("No model founded. Available models are: " + availablemodels());
            }
        }
    });
};

//# sourceMappingURL=data:application/json;base64,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QUFDLGFBQWEsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7d0JBRWpDLENBQUM7b0JBRUwsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUMsR0FBRzt3QkFDVCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7b0JBRWYsQ0FBQyxDQUFDLENBQUE7Z0JBR04sQ0FBQztZQUVMLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixNQUFNLENBQUMsMENBQTBDLEdBQUcsZUFBZSxFQUFFLENBQUMsQ0FBQTtZQUMxRSxDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFBO0FBQ04sQ0FBQyxDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgKiBhcyBhc3luYyBmcm9tIFwiYXN5bmNcIjtcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCI7XG5pbXBvcnQgbHN1c2JkZXYgZnJvbSBcImxzdXNiZGV2XCI7XG5cbmNvbnN0IG1ydHUgPSByZXF1aXJlKFwibW9kYnVzLXNlcmlhbFwiKTtcblxuY29uc3QgTW9kZWxzOiBJTW9kZWxbXSA9IHJlcXVpcmUoJy4vbW9kZWxzLmpzb24nKTtcbmxldCBNb2RlbDtcblxuXG5jb25zdCBDbGllbnQgPSBuZXcgbXJ0dSgpO1xuXG5pbnRlcmZhY2UgSVJlZ2lzdGVyIHtcbiAgICBsYWJlbDogc3RyaW5nO1xuICAgIHJlZzogbnVtYmVyO1xuICAgIGdyb3VwPzogc3RyaW5nO1xufVxuXG5cbmludGVyZmFjZSBJTW9kZWwge1xuICAgIGxhYmVsOiBzdHJpbmc7XG4gICAgcmVnaXN0ZXJzOiBJUmVnaXN0ZXJbXTtcbn1cblxuXG5cblxuXG5pbnRlcmZhY2UgRWFzdHJvbkRldmljZSB7XG4gICAgZGV2Pzogc3RyaW5nO1xuICAgIGh1Yj86IHN0cmluZztcbiAgICBiYXVkOiBudW1iZXI7XG4gICAgaWQ6IG51bWJlcjtcbiAgICB1aWQ/OiBzdHJpbmc7XG4gICAgbW9kZWw6IHN0cmluZztcbn1cblxuXG5leHBvcnQgZGVmYXVsdCAobzogRWFzdHJvbkRldmljZSkgPT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgbGV0IGFuc3dlcjogYW55ID0ge307XG5cbiAgICAgICAgbGV0IHJlZ2lzdGVyczogSVJlZ2lzdGVyW107XG5cblxuICAgICAgICBmdW5jdGlvbiBhdmFpbGFibGVtb2RlbHMoKTogc3RyaW5nW10ge1xuICAgICAgICAgICAgbGV0IG1vZGVsczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNb2RlbHMubGVuZ3RoOyBpKyspIHtcblxuICAgICAgICAgICAgICAgIG1vZGVscy5wdXNoKE1vZGVsc1tpXS5sYWJlbCk7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBtb2RlbHNcbiAgICAgICAgfVxuXG5cblxuICAgICAgICBmdW5jdGlvbiBjb25uZWN0UlRVKCkge1xuXG4gICAgICAgICAgICBmdW5jdGlvbiBzdGFydCgpIHtcblxuICAgICAgICAgICAgICAgIENsaWVudC5zZXRJRChvLmlkKTtcbiAgICAgICAgICAgICAgICBhc3luYy5lYWNoU2VyaWVzKHJlZ2lzdGVycywgKHJlZ2ksIGNiKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgQ2xpZW50LnJlYWRJbnB1dFJlZ2lzdGVycyhyZWdpLnJlZywgMiwgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVnaS5ncm91cCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFuc3dlcltyZWdpLmdyb3VwXSkgYW5zd2VyW3JlZ2kuZ3JvdXBdID0ge31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5zd2VyW3JlZ2kuZ3JvdXBdW3JlZ2kubGFiZWxdID0gZGF0YS5idWZmZXIucmVhZEZsb2F0QkUoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuc3dlcltyZWdpLmxhYmVsXSA9IGRhdGEuYnVmZmVyLnJlYWRGbG9hdEJFKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IoKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBDbGllbnQuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBrZyA9IHJlcXVpcmUoXCIuL3BhY2thZ2UuanNvblwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgYW5zd2VyLmFwaVZlcnNpb24gPSBwa2cubmFtZSArICcgLSAnICsgcGtnLnZlcnNpb247XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvLnVpZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuc3dlci51aWQgPSBvLnVpZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbnN3ZXIuX2lkID0gXCJjb25zdW1wdGlvbl9cIiArIG8udWlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBhbnN3ZXIudW5peFRpbWVzdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhbnN3ZXIpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBDbGllbnQuc2V0VGltZW91dCgxMDAwMCk7XG5cbiAgICAgICAgICAgIENsaWVudC5jb25uZWN0UlRVQnVmZmVyZWQoby5kZXYsIHsgYmF1ZHJhdGU6IG8uYmF1ZCB9LCBzdGFydCk7XG5cblxuICAgICAgICB9XG5cblxuXG5cbiAgICAgICAgaWYgKCFvKSB7XG4gICAgICAgICAgICByZWplY3QoXCJObyBjb25mIHByb3ZpZGVkXCIpXG4gICAgICAgIH0gZWxzZSBpZiAoIW8uZGV2ICYmICFvLmh1Yikge1xuICAgICAgICAgICAgcmVqZWN0KFwiTm8gZGV2XCIpXG4gICAgICAgIH0gZWxzZSBpZiAoIW8ubW9kZWwpIHtcbiAgICAgICAgICAgIHJlamVjdChcIk5vIG1vZGVsIHByb3ZpZGVkLiBBdmFpbGFibGUgbW9kZWxzIGFyZTogXCIgKyBhdmFpbGFibGVtb2RlbHMoKSlcbiAgICAgICAgfSBlbHNlIHtcblxuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1vZGVscy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChNb2RlbHNbaV0ubGFiZWwgPT09IG8ubW9kZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJzID0gTW9kZWxzW2ldLnJlZ2lzdGVycztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZWdpc3RlcnMgJiYgcmVnaXN0ZXJzLmxlbmd0aCAmJiByZWdpc3RlcnNbMF0gJiYgKHJlZ2lzdGVyc1swXS5yZWcgfHwgcmVnaXN0ZXJzWzBdLnJlZyA9PT0gMCkgJiYgcmVnaXN0ZXJzWzBdLmxhYmVsKSB7XG4gICAgICAgICAgICAgICAgaWYgKG8uZGV2KSB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdFJUVSgpO1xuXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICghby5kZXYgJiYgby5odWIpIHtcbiAgICAgICAgICAgICAgICAgICAgbHN1c2JkZXYoKS50aGVuKChkYXRhKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhW2ldLmh1YiA9PT0gby5odWIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgby5kZXYgPSBkYXRhW2ldLmRldjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvLmRldikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3RSVFUoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoXCJObyBkZXYgZm9yIFwiICsgby5odWIpXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuXG4gICAgICAgICAgICAgICAgICAgIH0pXG5cblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZWplY3QoXCJObyBtb2RlbCBmb3VuZGVkLiBBdmFpbGFibGUgbW9kZWxzIGFyZTogXCIgKyBhdmFpbGFibGVtb2RlbHMoKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pXG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
