"use strict";
var async = require("async");
var Promise = require("bluebird");
var lsusbdev_1 = require("lsusbdev");
var mrtu = require("modbus-serial");
var Models = require('./models.json');
var Model;
var Client = new mrtu();
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = function (o) {
    return new Promise(function (resolve, reject) {
        var answer = {};
        var registers;
        function availablemodels() {
            var models = [];
            for (var i = 0; i < Models.length; i++) {
                models.push(Models[i].label);
            }
            return models;
        }
        function connectRTU() {
            function start() {
                Client.setID(o.id);
                async.eachSeries(registers, function (regi, cb) {
                    Client.readInputRegisters(regi.reg, 2, function (err, data) {
                        if (err) {
                            cb(err);
                        }
                        else {
                            if (regi.group) {
                                if (!answer[regi.group])
                                    answer[regi.group] = {};
                                answer[regi.group][regi.label] = data.buffer.readFloatBE();
                            }
                            else {
                                answer[regi.label] = data.buffer.readFloatBE();
                            }
                            cb();
                        }
                    });
                }, function (err) {
                    if (err) {
                        reject(err);
                    }
                    else {
                        var pkg = require("./package.json");
                        answer.apiVersion = pkg.name + ' - ' + pkg.version;
                        if (o.uid) {
                            answer.uid = o.uid;
                            answer._id = "consumption_" + o.uid;
                        }
                        answer.unixTimestamp = new Date().getTime();
                        resolve(answer);
                    }
                });
            }
            Client.setTimeout(10000);
            Client.connectRTUBuffered(o.dev, { baudrate: o.baud }, start);
        }
        if (!o) {
            reject("No conf provided");
        }
        else if (!o.dev && !o.hub) {
            reject("No dev");
        }
        else if (!o.model) {
            reject("No model provided. Available models are: " + availablemodels());
        }
        else {
            for (var i = 0; i < Models.length; i++) {
                if (Models[i].label === o.model) {
                    registers = Models[i].registers;
                }
            }
            if (registers && registers.length && registers[0] && (registers[0].reg || registers[0].reg === 0) && registers[0].label) {
                if (o.dev) {
                    connectRTU();
                }
                else if (!o.dev && o.hub) {
                    lsusbdev_1.default().then(function (data) {
                        for (var i = 0; i < data.length; i++) {
                            if (data[i].hub === o.hub) {
                                o.dev = data[i].dev;
                            }
                        }
                        if (o.dev) {
                            connectRTU();
                        }
                        else {
                            reject("No dev for " + o.hub);
                        }
                    }).catch(function (err) {
                        reject(err);
                    });
                }
            }
            else {
                reject("No model founded. Available models are: " + availablemodels());
            }
        }
    });
};

//# sourceMappingURL=data:application/json;base64,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QUMsQ0FBQTt3QkFFakMsQ0FBQztvQkFFTCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO3dCQUNULE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFFZixDQUFDLENBQUMsQ0FBQTtnQkFHTixDQUFDO1lBRUwsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLE1BQU0sQ0FBQywwQ0FBMEMsR0FBRyxlQUFlLEVBQUUsQ0FBQyxDQUFBO1lBQzFFLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUE7QUFDTixDQUFDLENBQUEiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCAqIGFzIGFzeW5jIGZyb20gXCJhc3luY1wiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcbmltcG9ydCBsc3VzYmRldiBmcm9tIFwibHN1c2JkZXZcIjtcblxuY29uc3QgbXJ0dSA9IHJlcXVpcmUoXCJtb2RidXMtc2VyaWFsXCIpO1xuXG5jb25zdCBNb2RlbHM6IElNb2RlbFtdID0gcmVxdWlyZSgnLi9tb2RlbHMuanNvbicpO1xubGV0IE1vZGVsO1xuXG5cbmNvbnN0IENsaWVudCA9IG5ldyBtcnR1KCk7XG5cbmludGVyZmFjZSBJUmVnaXN0ZXIge1xuICAgIGxhYmVsOiBzdHJpbmc7XG4gICAgcmVnOiBudW1iZXI7XG4gICAgZ3JvdXA/OiBzdHJpbmc7XG59XG5cblxuaW50ZXJmYWNlIElNb2RlbCB7XG4gICAgbGFiZWw6IHN0cmluZztcbiAgICByZWdpc3RlcnM6IElSZWdpc3RlcltdO1xufVxuXG5cblxuXG5cbmludGVyZmFjZSBFYXN0cm9uRGV2aWNlIHtcbiAgICBkZXY/OiBzdHJpbmc7XG4gICAgaHViPzogc3RyaW5nO1xuICAgIGJhdWQ6IG51bWJlcjtcbiAgICBpZDogbnVtYmVyO1xuICAgIHVpZD86IHN0cmluZztcbiAgICBtb2RlbDogc3RyaW5nO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IChvOiBFYXN0cm9uRGV2aWNlKSA9PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICBsZXQgYW5zd2VyOiBhbnkgPSB7fTtcblxuICAgICAgICBsZXQgcmVnaXN0ZXJzOiBJUmVnaXN0ZXJbXTtcblxuXG4gICAgICAgIGZ1bmN0aW9uIGF2YWlsYWJsZW1vZGVscygpOiBzdHJpbmdbXSB7XG4gICAgICAgICAgICBsZXQgbW9kZWxzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1vZGVscy5sZW5ndGg7IGkrKykge1xuXG4gICAgICAgICAgICAgICAgbW9kZWxzLnB1c2goTW9kZWxzW2ldLmxhYmVsKTtcblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG1vZGVsc1xuICAgICAgICB9XG5cblxuXG4gICAgICAgIGZ1bmN0aW9uIGNvbm5lY3RSVFUoKSB7XG5cbiAgICAgICAgICAgIGZ1bmN0aW9uIHN0YXJ0KCkge1xuXG4gICAgICAgICAgICAgICAgQ2xpZW50LnNldElEKG8uaWQpO1xuICAgICAgICAgICAgICAgIGFzeW5jLmVhY2hTZXJpZXMocmVnaXN0ZXJzLCAocmVnaSwgY2IpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICBDbGllbnQucmVhZElucHV0UmVnaXN0ZXJzKHJlZ2kucmVnLCAyLCAoZXJyLCBkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2IoZXJyKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWdpLmdyb3VwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYW5zd2VyW3JlZ2kuZ3JvdXBdKSBhbnN3ZXJbcmVnaS5ncm91cF0gPSB7fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbnN3ZXJbcmVnaS5ncm91cF1bcmVnaS5sYWJlbF0gPSBkYXRhLmJ1ZmZlci5yZWFkRmxvYXRCRSgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5zd2VyW3JlZ2kubGFiZWxdID0gZGF0YS5idWZmZXIucmVhZEZsb2F0QkUoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYigpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwa2cgPSByZXF1aXJlKFwiLi9wYWNrYWdlLmpzb25cIilcbiAgICAgICAgICAgICAgICAgICAgICAgIGFuc3dlci5hcGlWZXJzaW9uID0gcGtnLm5hbWUgKyAnIC0gJyArIHBrZy52ZXJzaW9uO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoby51aWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbnN3ZXIudWlkID0gby51aWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5zd2VyLl9pZCA9IFwiY29uc3VtcHRpb25fXCIgKyBvLnVpZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgYW5zd2VyLnVuaXhUaW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYW5zd2VyKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgQ2xpZW50LnNldFRpbWVvdXQoMTAwMDApO1xuXG4gICAgICAgICAgICBDbGllbnQuY29ubmVjdFJUVUJ1ZmZlcmVkKG8uZGV2LCB7IGJhdWRyYXRlOiBvLmJhdWQgfSwgc3RhcnQpO1xuXG5cbiAgICAgICAgfVxuXG5cblxuXG4gICAgICAgIGlmICghbykge1xuICAgICAgICAgICAgcmVqZWN0KFwiTm8gY29uZiBwcm92aWRlZFwiKVxuICAgICAgICB9IGVsc2UgaWYgKCFvLmRldiAmJiAhby5odWIpIHtcbiAgICAgICAgICAgIHJlamVjdChcIk5vIGRldlwiKVxuICAgICAgICB9IGVsc2UgaWYgKCFvLm1vZGVsKSB7XG4gICAgICAgICAgICByZWplY3QoXCJObyBtb2RlbCBwcm92aWRlZC4gQXZhaWxhYmxlIG1vZGVscyBhcmU6IFwiICsgYXZhaWxhYmxlbW9kZWxzKCkpXG4gICAgICAgIH0gZWxzZSB7XG5cblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBNb2RlbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoTW9kZWxzW2ldLmxhYmVsID09PSBvLm1vZGVsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlZ2lzdGVycyA9IE1vZGVsc1tpXS5yZWdpc3RlcnM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVnaXN0ZXJzICYmIHJlZ2lzdGVycy5sZW5ndGggJiYgcmVnaXN0ZXJzWzBdICYmIChyZWdpc3RlcnNbMF0ucmVnIHx8IHJlZ2lzdGVyc1swXS5yZWcgPT09IDApICYmIHJlZ2lzdGVyc1swXS5sYWJlbCkge1xuICAgICAgICAgICAgICAgIGlmIChvLmRldikge1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3RSVFUoKTtcblxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIW8uZGV2ICYmIG8uaHViKSB7XG4gICAgICAgICAgICAgICAgICAgIGxzdXNiZGV2KCkudGhlbigoZGF0YSkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVtpXS5odWIgPT09IG8uaHViKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8uZGV2ID0gZGF0YVtpXS5kZXY7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoby5kZXYpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0UlRVKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KFwiTm8gZGV2IGZvciBcIiArIG8uaHViKVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcblxuICAgICAgICAgICAgICAgICAgICB9KVxuXG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KFwiTm8gbW9kZWwgZm91bmRlZC4gQXZhaWxhYmxlIG1vZGVscyBhcmU6IFwiICsgYXZhaWxhYmxlbW9kZWxzKCkpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
